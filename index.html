<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Museo de la Fragmentación 2000-2025</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Courier New', Courier, monospace; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            pointer-events: none;
            z-index: 10;
        }
        h1 {
            font-size: 2rem;
            text-transform: uppercase;
            letter-spacing: 5px;
            margin: 0;
            text-shadow: 0 0 10px #45b7d1;
        }
        .subtitle { color: #888; font-size: 0.9rem; }
        
        /* Tooltip */
        #tooltip {
            position: absolute;
            background: rgba(10, 10, 10, 0.9);
            border: 1px solid #45b7d1;
            padding: 15px;
            border-radius: 5px;
            color: white;
            display: none;
            pointer-events: none;
            backdrop-filter: blur(5px);
            max-width: 250px;
            box-shadow: 0 0 20px rgba(69, 183, 209, 0.2);
        }
        .score-val { font-size: 1.5rem; font-weight: bold; display: block; margin: 5px 0; }
        .aaa-color { color: #ff4d4d; }
        .indie-color { color: #45b7d1; }
        .year-label { font-size: 0.8rem; opacity: 0.7; text-transform: uppercase; }

        /* Loading */
        #loading {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #45b7d1;
            z-index: 999;
            transition: opacity 1s ease;
        }
        
        /* Controls Info */
        #controls-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.5);
            font-size: 0.8rem;
            pointer-events: none;
        }
    </style>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.154.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.154.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="loading"><h1>CARGANDO MUSEO DE DATOS...</h1></div>
    
    <div id="ui-layer">
        <h1>Fragmentación</h1>
        <div class="subtitle">VISUALIZACIÓN DE MERCADO 2000-2025</div>
    </div>

    <div id="tooltip"></div>
    
    <div id="controls-info">CLICK IZQ: Rotar | CLICK DER: Mover | RUEDA: Zoom/Avanzar</div>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';

        // --- DATOS (Extraídos de tu PDF y Análisis) ---
        const data = [
            { year: 2000, aaa: 88, indie: 15, event: "Era Retail: Dominio Total" },
            { year: 2001, aaa: 87, indie: 18, event: "" },
            { year: 2002, aaa: 86, indie: 21, event: "" },
            { year: 2003, aaa: 85, indie: 24, event: "Steam Lanzamiento" },
            { year: 2004, aaa: 84, indie: 27, event: "" },
            { year: 2005, aaa: 83, indie: 30, event: "" },
            { year: 2006, aaa: 82, indie: 33, event: "" },
            { year: 2007, aaa: 82, indie: 36, event: "Portal / BioShock" },
            { year: 2008, aaa: 81, indie: 39, event: "CRISIS / Braid (Boom Indie)" },
            { year: 2009, aaa: 80, indie: 42, event: "Minecraft Alpha" },
            { year: 2010, aaa: 79, indie: 45, event: "" },
            { year: 2011, aaa: 78, indie: 48, event: "Dark Souls (AA de Culto)" },
            { year: 2012, aaa: 77, indie: 51, event: "" },
            { year: 2013, aaa: 76, indie: 54, event: "" },
            { year: 2014, aaa: 75, indie: 57, event: "" },
            { year: 2015, aaa: 74, indie: 60, event: "Fragmentación / Steam Direct" },
            { year: 2016, aaa: 73, indie: 63, event: "" },
            { year: 2017, aaa: 72, indie: 66, event: "Hollow Knight" },
            { year: 2018, aaa: 71, indie: 69, event: "" },
            { year: 2019, aaa: 71, indie: 72, event: "" },
            { year: 2020, aaa: 70, indie: 75, event: "PUNTO DE INFLEXIÓN (Hades)" },
            { year: 2021, aaa: 69, indie: 78, event: "" },
            { year: 2022, aaa: 68, indie: 81, event: "Elden Ring (Anomalía)" },
            { year: 2023, aaa: 67, indie: 84, event: "Baldur's Gate 3 (El nuevo estándar)" },
            { year: 2024, aaa: 66, indie: 87, event: "Despidos Masivos AAA" },
            { year: 2025, aaa: 65, indie: 90, event: "Nuevo Orden Establecido" }
        ];

        // --- CONFIGURACIÓN ESCENA ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);
        scene.fog = new THREE.FogExp2(0x050505, 0.015);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(-15, 10, 30); // Empezamos al principio de la línea de tiempo

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- CONTROLES ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2 - 0.05; // No pasar bajo el suelo

        // --- LUCES ---
        const ambientLight = new THREE.AmbientLight(0x404040, 1);
        scene.add(ambientLight);

        // Luz direccional que simula un "sol digital"
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
        dirLight.position.set(10, 20, 10);
        scene.add(dirLight);

        // --- SUELO (GRID CIBERPUNK) ---
        const gridHelper = new THREE.GridHelper(200, 100, 0x333333, 0x111111);
        scene.add(gridHelper);

        const planeGeometry = new THREE.PlaneGeometry(200, 200);
        const planeMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x050505,
            roughness: 0.1,
            metalness: 0.8
        });
        const plane = new THREE.Mesh(planeGeometry, planeMaterial);
        plane.rotation.x = -Math.PI / 2;
        plane.position.y = -0.1;
        scene.add(plane);

        // --- SISTEMA DE INTERACCIÓN (RAYCASTER) ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let intersectedObject = null;
        const tooltip = document.getElementById('tooltip');

        // --- CONSTRUCCIÓN DEL MUSEO ---
        const group = new THREE.Group();
        scene.add(group);

        const barWidth = 1.5;
        const spacing = 4;
        
        // Materiales
        const matAAA = new THREE.MeshStandardMaterial({ 
            color: 0xff0000, 
            emissive: 0x550000,
            roughness: 0.2,
            metalness: 0.8
        });
        
        const matIndie = new THREE.MeshStandardMaterial({ 
            color: 0x00ffff, 
            emissive: 0x004444,
            roughness: 0.2,
            metalness: 0.8
        });

        const matBase = new THREE.MeshStandardMaterial({ color: 0x333333 });

        // Cargar fuente para los años
        const loader = new FontLoader();
        loader.load('https://unpkg.com/three@0.154.0/examples/fonts/helvetiker_regular.typeface.json', function (font) {
            
            // Ocultar loading
            document.getElementById('loading').style.opacity = 0;
            setTimeout(() => document.getElementById('loading').style.display = 'none', 1000);

            data.forEach((d, index) => {
                const zPos = index * spacing - (data.length * spacing) / 2;
                
                // 1. Pilar AAA (Izquierda) - Altura basada en nota
                const hAAA = d.aaa / 5; // Escalar para visualización
                const geoAAA = new THREE.BoxGeometry(barWidth, hAAA, barWidth);
                const meshAAA = new THREE.Mesh(geoAAA, matAAA.clone());
                meshAAA.position.set(-5, hAAA / 2, zPos);
                meshAAA.userData = { type: 'AAA', score: d.aaa, year: d.year, event: d.event };
                group.add(meshAAA);

                // 2. Pilar Indie (Derecha)
                const hIndie = d.indie / 5;
                const geoIndie = new THREE.BoxGeometry(barWidth, hIndie, barWidth);
                const meshIndie = new THREE.Mesh(geoIndie, matIndie.clone());
                meshIndie.position.set(5, hIndie / 2, zPos);
                meshIndie.userData = { type: 'INDIE', score: d.indie, year: d.year, event: d.event };
                group.add(meshIndie);

                // 3. Marcador de Año (Suelo)
                if (d.year % 5 === 0 || d.year === 2025 || d.year === 2008) {
                    const textGeo = new TextGeometry(d.year.toString(), {
                        font: font,
                        size: 1,
                        height: 0.1,
                    });
                    const textMesh = new THREE.Mesh(textGeo, new THREE.MeshBasicMaterial({ color: 0xffffff }));
                    textMesh.position.set(-1.5, 0.1, zPos);
                    textMesh.rotation.x = -Math.PI / 2;
                    group.add(textMesh);
                }

                // 4. Líneas conectoras (Efecto visual de tensión)
                if (index > 0) {
                    // Línea simple en el suelo
                    const points = [];
                    points.push(new THREE.Vector3(0, 0.1, zPos));
                    points.push(new THREE.Vector3(0, 0.1, zPos - spacing));
                    const lineGeo = new THREE.BufferGeometry().setFromPoints(points);
                    const lineMat = new THREE.LineBasicMaterial({ color: 0x333333 });
                    const line = new THREE.Line(lineGeo, lineMat);
                    group.add(line);
                }
                
                // Highlight Eventos Especiales (Pilares de luz)
                if(d.event.includes("CRISIS") || d.event.includes("INFLEXIÓN")) {
                    const light = new THREE.PointLight(0xffffff, 2, 10);
                    light.position.set(0, 2, zPos);
                    group.add(light);
                }
            });

        });

        // --- EFECTOS POST-PROCESADO (GLOW/BLOOM) ---
        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.2;
        bloomPass.strength = 1.2; // Intensidad del brillo neon
        bloomPass.radius = 0.5;

        const composer = new EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        // --- LÓGICA DE INTERACCIÓN ---
        function onMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            // Mover tooltip
            tooltip.style.left = event.clientX + 15 + 'px';
            tooltip.style.top = event.clientY + 15 + 'px';
        }

        window.addEventListener('mousemove', onMouseMove, false);
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- LOOP DE ANIMACIÓN ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            // Raycasting logic
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(group.children);

            if (intersects.length > 0) {
                const object = intersects[0].object;
                
                if (object.userData.year) { // Si es una barra de datos
                    if (intersectedObject !== object) {
                        // Reset anterior
                        if (intersectedObject) intersectedObject.material.emissive.setHex(intersectedObject.currentHex);
                        
                        // Highlight nuevo
                        intersectedObject = object;
                        intersectedObject.currentHex = intersectedObject.material.emissive.getHex();
                        intersectedObject.material.emissive.setHex(0xffffff);
                        
                        // Mostrar Tooltip
                        tooltip.style.display = 'block';
                        const colorClass = object.userData.type === 'AAA' ? 'aaa-color' : 'indie-color';
                        
                        let html = `
                            <div class="year-label">${object.userData.year}</div>
                            <span class="score-val ${colorClass}">${object.userData.score}/100</span>
                            <div style="font-size:0.8rem; border-top:1px solid #333; margin-top:5px; padding-top:5px;">
                                ${object.userData.type} INDUSTRY
                            </div>
                        `;
                        
                        if(object.userData.event) {
                            html += `<div style="margin-top:5px; color:#ffcc00; font-size:0.75rem;">⚠️ ${object.userData.event}</div>`;
                        }

                        tooltip.innerHTML = html;
                    }
                }
            } else {
                if (intersectedObject) {
                    intersectedObject.material.emissive.setHex(intersectedObject.currentHex);
                    intersectedObject = null;
                    tooltip.style.display = 'none';
                }
            }

            // Animación suave de las barras (efecto respiración)
            const time = Date.now() * 0.001;
            group.children.forEach((child, i) => {
                if(child.geometry && child.geometry.type === 'BoxGeometry') {
                   // Pequeña oscilación vertical
                   child.position.y += Math.sin(time + child.position.z) * 0.002;
                }
            });

            // Renderizar con Bloom
            composer.render();
        }

        animate();
    </script>
</body>
</html>

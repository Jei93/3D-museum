<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline de la Industria: Control Gestual</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap');

        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Rajdhani', sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }

        /* UI Overlay Layer */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
            z-index: 10;
        }

        /* Header */
        .header {
            text-align: left;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        h1 { margin: 0; color: white; font-size: 2.5rem; text-transform: uppercase; letter-spacing: 2px; }
        .legend { display: flex; gap: 20px; margin-top: 10px; font-size: 0.9rem; }
        .dot { width: 12px; height: 12px; display: inline-block; border-radius: 50%; margin-right: 5px; }
        .l-aaa { color: #ff4d4d; } .d-aaa { background: #ff4d4d; box-shadow: 0 0 8px #ff4d4d; }
        .l-aa { color: #ffd700; } .d-aa { background: #ffd700; box-shadow: 0 0 8px #ffd700; }
        .l-indie { color: #00ffff; } .d-indie { background: #00ffff; box-shadow: 0 0 8px #00ffff; }

        /* Camera Feedback */
        #cam-preview {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 160px;
            height: 120px;
            border: 2px solid #333;
            border-radius: 10px;
            transform: scaleX(-1); /* Espejo */
            opacity: 0.7;
            z-index: 20;
            background: #000;
        }
        
        /* Status & Instructions */
        #status-bar {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: rgba(255,255,255,0.8);
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 1.2rem;
            width: 60%;
        }
        .highlight { color: #00ffff; font-weight: bold; }

        /* Tooltip Flotante 3D (Simulado en 2D) */
        #tooltip {
            position: absolute;
            background: rgba(10, 15, 20, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 8px;
            color: white;
            display: none;
            backdrop-filter: blur(10px);
            width: 300px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            transition: opacity 0.2s;
        }
        .tt-year { font-size: 2rem; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; }
        .tt-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .tt-event { margin-top: 10px; font-style: italic; color: #ffd700; border-left: 3px solid #ffd700; padding-left: 10px; }

        /* Loading Screen */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: #00ffff;
        }
        .loader-bar { width: 200px; height: 4px; background: #333; margin-top: 20px; border-radius: 2px; }
        .loader-progress { width: 0%; height: 100%; background: #00ffff; transition: width 0.3s; }

    </style>

    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.154.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.154.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="loader">
        <h2>INICIALIZANDO SISTEMA NEURAL...</h2>
        <div style="font-size: 0.8rem; opacity: 0.7">Permite el acceso a la c√°mara para el control gestual</div>
        <div class="loader-bar"><div class="loader-progress" id="load-bar"></div></div>
    </div>

    <div id="ui-layer">
        <div class="header">
            <h1>Game Industry <span style="font-weight: 300; opacity: 0.7">Timeline</span></h1>
            <div class="legend">
                <span class="l-aaa"><span class="dot d-aaa"></span>AAA (Blockbuster)</span>
                <span class="l-aa"><span class="dot d-aa"></span>AA (Est√°ndar Dorado)</span>
                <span class="l-indie"><span class="dot d-indie"></span>Indie (Innovaci√≥n)</span>
            </div>
        </div>
        
        <div id="status-bar">
            üëã Levanta tu mano para navegar. <span class="highlight">Izquierda/Derecha</span> para viajar en el tiempo.
        </div>
    </div>

    <div id="tooltip"></div>

    <video id="input-video" style="display:none"></video>
    <canvas id="cam-preview"></canvas>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';

        // ==========================================
        // 1. DATASET COMPLETO (AAA + AA + INDIE)
        // ==========================================
        const data = [
            { year: 2000, aaa: 88, aa: 35, indie: 15, event: "Hegemon√≠a Retail. AAA domina el 88% del mercado." },
            { year: 2001, aaa: 87, aa: 36, indie: 18, event: "" },
            { year: 2002, aaa: 86, aa: 38, indie: 21, event: "" },
            { year: 2003, aaa: 85, aa: 39, indie: 24, event: "Nace Steam (Valve). Comienza la era digital." },
            { year: 2004, aaa: 84, aa: 41, indie: 27, event: "Half-Life 2 define la f√≠sica en juegos." },
            { year: 2005, aaa: 83, aa: 42, indie: 30, event: "" },
            { year: 2006, aaa: 82, aa: 44, indie: 33, event: "" },
            { year: 2007, aaa: 82, aa: 45, indie: 36, event: "Bioshock y Portal: Narrativa emergente." },
            { year: 2008, aaa: 81, aa: 47, indie: 39, event: "CRISIS ECON√ìMICA + Braid (El Boom Indie)." },
            { year: 2009, aaa: 80, aa: 48, indie: 42, event: "Minecraft en Alpha. El cambio de paradigma." },
            { year: 2010, aaa: 79, aa: 50, indie: 45, event: "" },
            { year: 2011, aaa: 78, aa: 52, indie: 48, event: "Dark Souls: El AA define un nuevo g√©nero." },
            { year: 2012, aaa: 77, aa: 54, indie: 51, event: "Indie Game: The Movie populariza el sector." },
            { year: 2013, aaa: 76, aa: 56, indie: 54, event: "" },
            { year: 2014, aaa: 75, aa: 58, indie: 57, event: "" },
            { year: 2015, aaa: 74, aa: 60, indie: 60, event: "Steam Direct. Saturaci√≥n del mercado." },
            { year: 2016, aaa: 73, aa: 62, indie: 63, event: "" },
            { year: 2017, aaa: 72, aa: 64, indie: 66, event: "Hollow Knight / Hellblade (AA de lujo)." },
            { year: 2018, aaa: 71, aa: 76, indie: 69, event: "El AA supera al AAA en percepci√≥n cr√≠tica." },
            { year: 2019, aaa: 71, aa: 75, indie: 72, event: "" },
            { year: 2020, aaa: 70, aa: 74, indie: 75, event: "PUNTO DE INFLEXI√ìN: Hades (Indie) gana GOTY." },
            { year: 2021, aaa: 69, aa: 73, indie: 78, event: "" },
            { year: 2022, aaa: 68, aa: 72, indie: 81, event: "Elden Ring (Anomal√≠a exitosa)." },
            { year: 2023, aaa: 67, aa: 70, indie: 84, event: "Baldur's Gate 3: El triunfo del modelo cl√°sico." },
            { year: 2024, aaa: 66, aa: 69, indie: 87, event: "Despidos masivos en estudios AAA." },
            { year: 2025, aaa: 65, aa: 68, indie: 90, event: "NUEVO ORDEN: Indie lidera, AA estabiliza." }
        ];

        // ==========================================
        // 2. CONFIGURACI√ìN THREE.JS
        // ==========================================
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);
        scene.fog = new THREE.FogExp2(0x050505, 0.02); // Niebla densa para ocultar el final

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Iluminaci√≥n
        const ambientLight = new THREE.AmbientLight(0x404040, 2);
        scene.add(ambientLight);
        
        const sunLight = new THREE.DirectionalLight(0xffffff, 1);
        sunLight.position.set(0, 20, 10);
        scene.add(sunLight);

        // Suelo Grid Infinito
        const grid = new THREE.GridHelper(200, 100, 0x333333, 0x111111);
        scene.add(grid);

        // Grupo principal
        const timelineGroup = new THREE.Group();
        scene.add(timelineGroup);

        // Materiales
        const matAAA = new THREE.MeshStandardMaterial({ color: 0xff4d4d, roughness: 0.1, metalness: 0.8, emissive: 0x550000 });
        const matAA = new THREE.MeshStandardMaterial({ color: 0xffd700, roughness: 0.1, metalness: 0.9, emissive: 0x665500 });
        const matIndie = new THREE.MeshStandardMaterial({ color: 0x00ffff, roughness: 0.1, metalness: 0.8, emissive: 0x004444 });
        
        // ==========================================
        // 3. CONSTRUCCI√ìN DEL MUNDO (GENERACI√ìN PROCEDURAL)
        // ==========================================
        const spacing = 6; // Espacio entre a√±os
        
        const loader = new FontLoader();
        loader.load('https://unpkg.com/three@0.154.0/examples/fonts/helvetiker_bold.typeface.json', function (font) {
            
            data.forEach((d, i) => {
                const z = -i * spacing;
                
                // --- BARRA AAA (Izquierda Lejana) ---
                const hAAA = d.aaa / 8;
                const meshAAA = new THREE.Mesh(new THREE.BoxGeometry(1, hAAA, 1), matAAA);
                meshAAA.position.set(-6, hAAA/2, z);
                timelineGroup.add(meshAAA);

                // --- BARRA AA (Centro-Izquierda) ---
                const hAA = d.aa / 8;
                const meshAA = new THREE.Mesh(new THREE.BoxGeometry(1, hAA, 1), matAA);
                meshAA.position.set(-2, hAA/2, z);
                timelineGroup.add(meshAA);

                // --- BARRA INDIE (Derecha) ---
                const hIndie = d.indie / 8;
                const meshIndie = new THREE.Mesh(new THREE.BoxGeometry(1, hIndie, 1), matIndie);
                meshIndie.position.set(2, hIndie/2, z);
                timelineGroup.add(meshIndie);

                // --- SUELO DEL A√ëO ---
                const yearGeo = new TextGeometry(d.year.toString(), { font: font, size: 0.8, height: 0.1 });
                const yearMesh = new THREE.Mesh(yearGeo, new THREE.MeshBasicMaterial({ color: 0xffffff }));
                yearMesh.position.set(4, 0.1, z);
                yearMesh.rotation.x = -Math.PI / 2;
                timelineGroup.add(yearMesh);

                // --- L√çNEAS DE CONEXI√ìN (VISUAL) ---
                if (i > 0) {
                    const prevZ = -(i-1) * spacing;
                    // Conexi√≥n sutil en el suelo
                    const lineGeo = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(0, 0.05, prevZ), new THREE.Vector3(0, 0.05, z)
                    ]);
                    const line = new THREE.Line(lineGeo, new THREE.LineBasicMaterial({ color: 0x333333 }));
                    timelineGroup.add(line);
                }

                // Guardar datos en un objeto invisible para Raycasting/Detecci√≥n
                const triggerObj = new THREE.Mesh(new THREE.BoxGeometry(14, 10, spacing), new THREE.MeshBasicMaterial({ visible: false }));
                triggerObj.position.set(0, 5, z);
                triggerObj.userData = d; // Guardar datos aqu√≠
                timelineGroup.add(triggerObj);
            });

            document.getElementById('load-bar').style.width = '100%';
            setTimeout(() => document.getElementById('loader').style.display = 'none', 1000);
        });

        // ==========================================
        // 4. POST-PROCESSING (BLOOM)
        // ==========================================
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.1;
        bloomPass.strength = 0.8;
        bloomPass.radius = 0.5;
        composer.addPass(bloomPass);

        // ==========================================
        // 5. SISTEMA DE CONTROL GESTUAL (MEDIAPIPE)
        // ==========================================
        const videoElement = document.getElementById('input-video');
        const canvasElement = document.getElementById('cam-preview');
        const canvasCtx = canvasElement.getContext('2d');
        
        let targetZ = 0; // Donde queremos que est√© la c√°mara
        let currentZ = 0; // Donde est√° realmente la c√°mara (interpolaci√≥n)
        let handX = 0.5; // Posici√≥n X de la mano (0 a 1)

        function onResults(results) {
            // Dibujar preview de c√°mara
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const hand = results.multiHandLandmarks[0];
                
                // Dibujar esqueleto simple
                drawConnectors(canvasCtx, hand, HAND_CONNECTIONS, {color: '#00ffff', lineWidth: 2});
                
                // Usar la posici√≥n X de la mu√±eca o dedo √≠ndice para controlar el tiempo
                // MediaPipe X: 0 (izq) a 1 (der). Invertido por el efecto espejo.
                handX = 1 - hand[8].x; // Punta del dedo √≠ndice
                
                // Feedback visual en UI
                const status = document.getElementById('status-bar');
                if (handX < 0.3) {
                    status.innerHTML = "‚è™ Rebobinando al Pasado";
                    status.style.color = "#ff4d4d";
                } else if (handX > 0.7) {
                    status.innerHTML = "‚è© Avanzando al Futuro";
                    status.style.color = "#00ffff";
                } else {
                    status.innerHTML = "‚è∏Ô∏è Pausado / Zona Muerta";
                    status.style.color = "white";
                }

            } else {
                document.getElementById('status-bar').innerText = "‚ùå Mano no detectada. Usa el rat√≥n.";
                handX = 0.5; // Neutral
            }
            canvasCtx.restore();
        }

        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});
        
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        hands.onResults(onResults);

        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 320,
            height: 240
        });
        cameraUtils.start();

        // ==========================================
        // 6. L√ìGICA DE MOVIMIENTO Y VISUALIZACI√ìN
        // ==========================================
        
        // Raycaster para detectar en qu√© a√±o estamos
        const raycaster = new THREE.Raycaster();
        const tooltip = document.getElementById('tooltip');

        function updateCamera() {
            // Velocidad base
            let speed = 0;
            
            // L√≥gica de control con la mano
            // Zona muerta entre 0.4 y 0.6
            if (handX > 0.65) speed = -0.3; // Avanzar (Z negativo)
            if (handX < 0.35) speed = 0.3;  // Retroceder
            
            targetZ += speed;

            // L√≠mites
            const maxZ = 2; 
            const minZ = -(data.length * spacing) - 5;
            if (targetZ > maxZ) targetZ = maxZ;
            if (targetZ < minZ) targetZ = minZ;

            // Suavizado (Lerp) para que no maree
            currentZ += (targetZ - currentZ) * 0.05;

            // Posicionar c√°mara
            camera.position.set(0, 4, currentZ + 10); // C√°mara detr√°s del punto actual
            camera.lookAt(0, 2, currentZ - 10); // Mirar hacia adelante
        }

        function checkDataIntersection() {
            // Lanzar rayo hacia abajo desde la posici√≥n "virtual" de la c√°mara
            const origin = new THREE.Vector3(0, 10, currentZ);
            const direction = new THREE.Vector3(0, -1, 0);
            raycaster.set(origin, direction);

            const intersects = raycaster.intersectObjects(timelineGroup.children);
            
            if (intersects.length > 0) {
                const obj = intersects[0].object;
                if (obj.userData && obj.userData.year) {
                    const d = obj.userData;
                    
                    // Actualizar Tooltip
                    tooltip.style.display = 'block';
                    tooltip.innerHTML = `
                        <div class="tt-year">${d.year}</div>
                        <div class="tt-row"><span class="l-aaa">AAA Power</span> <span>${d.aaa}/100</span></div>
                        <div class="tt-row"><span class="l-aa">AA Power</span> <span>${d.aa}/100</span></div>
                        <div class="tt-row"><span class="l-indie">Indie Power</span> <span>${d.indie}/100</span></div>
                        ${d.event ? `<div class="tt-event">${d.event}</div>` : ''}
                    `;
                }
            }
        }

        // ==========================================
        // 7. LOOP PRINCIPAL
        // ==========================================
        function animate() {
            requestAnimationFrame(animate);
            
            updateCamera();
            checkDataIntersection();
            
            composer.render();
        }

        // Listeners b√°sicos
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

        // Fallback Mouse Control (si falla la c√°mara o para testing)
        window.addEventListener('mousemove', (e) => {
            if(!videoElement.srcObject) { // Solo si no hay video
                handX = e.clientX / window.innerWidth;
            }
        });

        animate();

    </script>
</body>
</html>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presentación de Datos: The Gaming Shift</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@300;600;800&family=JetBrains+Mono:wght@500&display=swap');

        body { margin: 0; overflow: hidden; background-color: #0a0a0a; font-family: 'Manrope', sans-serif; }
        
        /* --- HUD (HEADS UP DISPLAY) --- */
        #top-bar {
            position: absolute;
            top: 0; left: 0; width: 100%;
            padding: 30px 50px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            z-index: 10;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
        }
        
        h1 {
            color: white; margin: 0; font-weight: 800; font-size: 1.8rem;
            letter-spacing: -0.5px; text-transform: uppercase;
        }
        
        /* Indicador de Estado de Navegación */
        .nav-status {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #555; transition: background 0.3s; }
        .status-text { color: rgba(255,255,255,0.8); font-size: 0.8rem; font-family: 'JetBrains Mono'; text-transform: uppercase; }

        /* Estados del indicador */
        .nav-status.moving .status-dot { background: #00ffff; box-shadow: 0 0 10px #00ffff; }
        .nav-status.locked .status-dot { background: #ffcc00; box-shadow: 0 0 10px #ffcc00; }
        .nav-status.locked .status-text { color: #ffcc00; font-weight: bold; }

        /* PANEL DE DETALLE INFERIOR (Solo aparece al bloquear) */
        #detail-panel {
            position: absolute;
            bottom: 40px; left: 50%;
            transform: translateX(-50%) translateY(150%); /* Oculto abajo */
            width: 90%; max-width: 1000px;
            background: rgba(15, 15, 15, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            color: white;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        #detail-panel.active { transform: translateX(-50%) translateY(0); }

        .detail-left { width: 60%; padding-right: 30px; border-right: 1px solid rgba(255,255,255,0.1); }
        .detail-year { font-size: 3.5rem; font-weight: 800; line-height: 1; margin-bottom: 10px; background: linear-gradient(45deg, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
        .detail-event { font-size: 1.2rem; color: #ffcc00; margin-bottom: 5px; font-weight: 600; }
        .detail-desc { font-size: 0.95rem; color: #bbb; line-height: 1.5; }

        .detail-right { width: 35%; display: flex; flex-direction: column; gap: 10px; }
        .bar-container { display: flex; align-items: center; gap: 10px; font-family: 'JetBrains Mono'; font-size: 0.8rem; }
        .bar-label { width: 50px; color: #666; }
        .bar-bg { flex-grow: 1; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 1s ease-out; }
        .bar-val { width: 30px; text-align: right; color: white; }

        /* Colores */
        .c-aaa { color: #ff4d4d; } .bg-aaa { background: #ff4d4d; }
        .c-aa { color: #ffd700; } .bg-aa { background: #ffd700; }
        .c-indie { color: #00ffff; } .bg-indie { background: #00ffff; }

        /* Feedback visual de mano */
        #hand-guide {
            position: absolute;
            bottom: 20px; right: 20px;
            font-size: 0.7rem; color: rgba(255,255,255,0.3);
            text-align: right; pointer-events: none;
        }

        /* Loader */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0a0a0a; z-index: 100;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: white; font-family: 'Manrope';
        }
        .loader-spinner {
            width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #00ffff; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.154.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.154.0/examples/jsm/" } }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="loader">
        <div class="loader-spinner"></div>
        <p>CALIBRANDO ENTORNO 3D...</p>
    </div>

    <div id="top-bar">
        <h1>Market<span style="color:#666">Shift</span> <span style="font-size:0.5em; vertical-align:middle; background:#333; padding:2px 6px; border-radius:4px;">LIVE DATA</span></h1>
        
        <div class="nav-status" id="nav-badge">
            <div class="status-dot"></div>
            <div class="status-text" id="status-text">LISTO</div>
        </div>
    </div>

    <div id="detail-panel">
        <div class="detail-left">
            <div class="detail-year" id="ui-year">2000</div>
            <div class="detail-event" id="ui-event"></div>
            <div class="detail-desc" id="ui-desc"></div>
        </div>
        <div class="detail-right">
            <div class="bar-container">
                <span class="bar-label">AAA</span>
                <div class="bar-bg"><div class="bar-fill bg-aaa" id="fill-aaa"></div></div>
                <span class="bar-val" id="val-aaa">0</span>
            </div>
            <div class="bar-container">
                <span class="bar-label">AA</span>
                <div class="bar-bg"><div class="bar-fill bg-aa" id="fill-aa"></div></div>
                <span class="bar-val" id="val-aa">0</span>
            </div>
            <div class="bar-container">
                <span class="bar-label">INDIE</span>
                <div class="bar-bg"><div class="bar-fill bg-indie" id="fill-indie"></div></div>
                <span class="bar-val" id="val-indie">0</span>
            </div>
        </div>
    </div>

    <div id="hand-guide">
        Control Gestual Activo<br>Centro: Auto-Lock | Lados: Navegar
    </div>

    <video id="input-video" style="display:none"></video>
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- DATOS ---
        const data = [
            { year: 2000, aaa: 88, aa: 35, indie: 15, title: "Hegemonía Retail", desc: "El formato físico es rey. Los AAA dominan el 88% del mercado global." },
            { year: 2001, aaa: 87, aa: 36, indie: 18, title: "", desc: "" },
            { year: 2002, aaa: 86, aa: 38, indie: 21, title: "", desc: "" },
            { year: 2003, aaa: 85, aa: 39, indie: 24, title: "Nace Steam", desc: "Valve inicia la transición digital. Comienza tímida, pero cambiará todo." },
            { year: 2004, aaa: 84, aa: 41, indie: 27, title: "", desc: "" },
            { year: 2005, aaa: 83, aa: 42, indie: 30, title: "", desc: "" },
            { year: 2006, aaa: 82, aa: 44, indie: 33, title: "", desc: "" },
            { year: 2007, aaa: 82, aa: 45, indie: 36, title: "Narrativa Emergente", desc: "BioShock y Portal: El guion empieza a pesar más que los polígonos." },
            { year: 2008, aaa: 81, aa: 47, indie: 39, title: "CRISIS & BRAID", desc: "Crisis financiera global + Lanzamiento de Braid: El Boom Indie comienza." },
            { year: 2009, aaa: 80, aa: 48, indie: 42, title: "Minecraft Alpha", desc: "Un solo desarrollador cambia las reglas. El poder de la comunidad." },
            { year: 2010, aaa: 79, aa: 50, indie: 45, title: "", desc: "" },
            { year: 2011, aaa: 78, aa: 52, indie: 48, title: "Dark Souls", desc: "FromSoftware define el AA moderno: Nicho, difícil y de altísima calidad." },
            { year: 2012, aaa: 77, aa: 54, indie: 51, title: "", desc: "" },
            { year: 2013, aaa: 76, aa: 56, indie: 54, title: "", desc: "" },
            { year: 2014, aaa: 75, aa: 58, indie: 57, title: "", desc: "" },
            { year: 2015, aaa: 74, aa: 60, indie: 60, title: "Saturación Steam", desc: "Steam Direct. Demasiados juegos, la visibilidad es el nuevo oro." },
            { year: 2016, aaa: 73, aa: 62, indie: 63, title: "", desc: "" },
            { year: 2017, aaa: 72, aa: 64, indie: 66, title: "Indies Masivos", desc: "Hollow Knight. Calidad AAA a precio Indie." },
            { year: 2018, aaa: 71, aa: 76, indie: 69, title: "Sorpasso de Calidad", desc: "La media crítica de los AA supera por primera vez a los AAA genéricos." },
            { year: 2019, aaa: 71, aa: 75, indie: 72, title: "", desc: "" },
            { year: 2020, aaa: 70, aa: 74, indie: 75, title: "PUNTO DE INFLEXIÓN", desc: "Hades (Indie) gana GOTY. La barrera AAA/Indie se rompe." },
            { year: 2021, aaa: 69, aa: 73, indie: 78, title: "", desc: "" },
            { year: 2022, aaa: 68, aa: 72, indie: 81, title: "La Anomalía", desc: "Elden Ring: Un AA con esteroides domina el mundo." },
            { year: 2023, aaa: 67, aa: 70, indie: 84, title: "El Nuevo Estándar", desc: "Baldur's Gate 3 demuestra que la profundidad gana a la monetización." },
            { year: 2024, aaa: 66, aa: 69, indie: 87, title: "Colapso Laboral", desc: "Costes insostenibles en AAA provocan despidos masivos." },
            { year: 2025, aaa: 65, aa: 68, indie: 90, title: "EL NUEVO ORDEN", desc: "Indie lidera innovación. AA es el estándar de calidad. AAA es nicho." }
        ];

        // --- CONFIGURACIÓN THREE.JS ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0a); // Gris muy oscuro, no negro puro
        scene.fog = new THREE.Fog(0x0a0a0a, 10, 50);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        renderer.toneMappingExposure = 1.2; // Más brillante
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- ILUMINACIÓN DE ESTUDIO (MEJORADA) ---
        // 1. Luz Ambiental base (para que nada sea negro absoluto)
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6); 
        scene.add(ambientLight);

        // 2. Hemisphere Light (Cielo azulado / Suelo cálido)
        const hemiLight = new THREE.HemisphereLight(0xddeeff, 0x222222, 0.5);
        scene.add(hemiLight);

        // 3. Key Light (Principal que genera sombras suaves)
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(5, 10, 5);
        scene.add(dirLight);

        // --- MATERIALES (OPTIMIZADOS PARA LUZ) ---
        // Usamos emissive suave para que siempre se vean los colores
        const matAAA = new THREE.MeshStandardMaterial({ 
            color: 0xff4d4d, roughness: 0.3, metalness: 0.5, emissive: 0x550000, emissiveIntensity: 0.2 
        });
        const matAA = new THREE.MeshStandardMaterial({ 
            color: 0xffd700, roughness: 0.3, metalness: 0.6, emissive: 0x664400, emissiveIntensity: 0.2 
        });
        const matIndie = new THREE.MeshStandardMaterial({ 
            color: 0x00ffff, roughness: 0.3, metalness: 0.5, emissive: 0x003333, emissiveIntensity: 0.2 
        });
        const matText = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.8 });
        const matScore = new THREE.MeshBasicMaterial({ color: 0xcccccc });

        // --- CONSTRUCCIÓN ---
        const group = new THREE.Group();
        scene.add(group);
        const spacing = 10; // Más espacio entre años
        
        const loader = new FontLoader();
        loader.load('https://unpkg.com/three@0.154.0/examples/fonts/helvetiker_bold.typeface.json', (font) => {
            
            data.forEach((d, i) => {
                const z = -i * spacing;
                
                // 1. Barras (Escaladas)
                const hAAA = d.aaa / 8;
                const hAA = d.aa / 8;
                const hIndie = d.indie / 8;

                // AAA (Izq)
                const b1 = new THREE.Mesh(new THREE.BoxGeometry(2, hAAA, 2), matAAA);
                b1.position.set(-6, hAAA/2, z);
                group.add(b1);
                addFloatingScore(d.aaa, -6, hAAA, z, font);

                // AA (Centro)
                const b2 = new THREE.Mesh(new THREE.BoxGeometry(2, hAA, 2), matAA);
                b2.position.set(0, hAA/2, z);
                group.add(b2);
                addFloatingScore(d.aa, 0, hAA, z, font);

                // Indie (Der)
                const b3 = new THREE.Mesh(new THREE.BoxGeometry(2, hIndie, 2), matIndie);
                b3.position.set(6, hIndie/2, z);
                group.add(b3);
                addFloatingScore(d.indie, 6, hIndie, z, font);

                // 2. Año (Suelo)
                const tGeo = new TextGeometry(d.year.toString(), { font, size: 2, height: 0.1 });
                tGeo.center(); // Centrar texto
                const tMesh = new THREE.Mesh(tGeo, matText);
                tMesh.position.set(10, 0.1, z); // Al lado derecho
                tMesh.rotation.x = -Math.PI/2;
                tMesh.rotation.z = Math.PI/2; // Orientado hacia la cámara lateral
                group.add(tMesh);
                
                // Trigger invisible para lógica
                const trigger = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshBasicMaterial({visible:false}));
                trigger.position.set(0,0,z);
                trigger.userData = d; // Guardar datos
                group.add(trigger);
            });
            document.getElementById('loader').style.display = 'none';
        });

        // Función auxiliar para poner números flotantes 3D
        function addFloatingScore(val, x, y, z, font) {
            const size = 0.8;
            const geo = new TextGeometry(val.toString(), { font, size: size, height: 0.05 });
            geo.center();
            const mesh = new THREE.Mesh(geo, matScore);
            mesh.position.set(x, y + 1.5, z); // Flotando encima de la barra
            group.add(mesh);
        }

        // Bloom suave (Glow)
        const composer = new EffectComposer(renderer);
        const renderPass = new RenderPass(scene, camera);
        composer.addPass(renderPass);
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloom.threshold = 0.2; bloom.strength = 0.4; bloom.radius = 0.5;
        composer.addPass(bloom);

        // --- SISTEMA DE CONTROL (MAGNÉTICO) ---
        let currentZ = 0;
        let targetZ = 0;
        let handX = 0.5; // 0.5 = Centro (Neutral)
        let isLocking = false; // Si estamos en proceso de auto-snap
        let lockedIndex = -1; // Índice del año bloqueado

        // UI Refs
        const navBadge = document.getElementById('nav-badge');
        const statusText = document.getElementById('status-text');
        const detailPanel = document.getElementById('detail-panel');

        // MediaPipe
        const video = document.getElementById('input-video');
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7 });
        
        hands.onResults((results) => {
            if (results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                handX = 1 - lm[9].x; // Invertir eje X (Espejo)
                
                // Cerrar puño (opcional, pero mantenemos la lógica por si acaso)
                // Usaremos lógica de "Zona Muerta" para el anclaje automático
            } else {
                handX = 0.5; // Neutral si no hay mano
            }
        });

        const cam = new Camera(video, { onFrame: async () => await hands.send({image: video}), width: 640, height: 480 });
        cam.start();

        function animate() {
            requestAnimationFrame(animate);

            // --- LÓGICA DE NAVEGACIÓN MEJORADA ---
            let speed = 0;
            const deadZone = 0.15; // Ancho de la zona central
            
            // 1. Calcular velocidad basada en mano
            if (handX > 0.5 + deadZone) {
                speed = -0.6 * (handX - 0.5); // Avanzar (Derecha)
                isLocking = false;
            } else if (handX < 0.5 - deadZone) {
                speed = 0.6 * (0.5 - handX); // Retroceder (Izquierda)
                isLocking = false;
            } else {
                // 2. LÓGICA MAGNÉTICA (La mano está en el centro)
                isLocking = true;
            }

            // Aplicar velocidad al objetivo
            if (!isLocking) {
                targetZ += speed;
                detailPanel.classList.remove('active');
                
                navBadge.className = 'nav-status moving';
                statusText.innerText = speed < 0 ? "AVANZANDO >>>" : "<<< RETROCEDIENDO";
                
                // Limitar límites
                const minZ = -(data.length - 1) * spacing;
                targetZ = Math.max(minZ - 5, Math.min(5, targetZ)); // Margen pequeño
                
                lockedIndex = -1;
            } else {
                // 3. AUTO-SNAP (Atracción al año más cercano)
                // Calcular qué índice está más cerca
                const nearestIndex = Math.round(Math.abs(targetZ) / spacing);
                const snapTarget = -nearestIndex * spacing;
                
                // Mover targetZ suavemente hacia el snapTarget
                targetZ += (snapTarget - targetZ) * 0.1;

                // Si estamos muy cerca, activar panel
                if (Math.abs(targetZ - snapTarget) < 0.5 && lockedIndex !== nearestIndex) {
                    lockedIndex = nearestIndex;
                    const d = data[nearestIndex];
                    if(d) {
                        navBadge.className = 'nav-status locked';
                        statusText.innerText = "BLOQUEADO: " + d.year;
                        
                        // Actualizar UI
                        document.getElementById('ui-year').innerText = d.year;
                        document.getElementById('ui-event').innerText = d.title || "Tendencia de Mercado";
                        document.getElementById('ui-desc').innerText = d.desc || "Sin eventos críticos registrados este año.";
                        
                        // Animar barras HTML
                        document.getElementById('fill-aaa').style.width = d.aaa + '%';
                        document.getElementById('val-aaa').innerText = d.aaa;
                        
                        document.getElementById('fill-aa').style.width = d.aa + '%';
                        document.getElementById('val-aa').innerText = d.aa;
                        
                        document.getElementById('fill-indie').style.width = d.indie + '%';
                        document.getElementById('val-indie').innerText = d.indie;

                        detailPanel.classList.add('active');
                    }
                }
            }

            // Interpolación de cámara (Smoothness extrema)
            currentZ += (targetZ - currentZ) * 0.08;

            // Posicionamiento de cámara cinematográfica
            // Un poco elevada, mirando hacia abajo y adelante
            camera.position.set(0, 8, currentZ + 18);
            camera.lookAt(0, 2, currentZ);

            composer.render();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
